#include "../CliFrontend.h"
#include "../GameController.h"
#include "../Position.h"
#include "../bit_tools.h"

#include <iostream>
#include <vector>

using std::string, std::cin, std::cout, std::endl;

std::vector<Move> legalMoves;

Move getMoveFromStdin(std::shared_ptr<Position> pos) {
    Move candidate;
    bool validMove = false;
    bool pawnPromoting = false;

    while (!validMove) {
        // pick a random move to suggest
        const std::string sample = legalMoves[std::rand() % legalMoves.size()].toCoordinateString();

        // DEBUG: print legal moves
        pos->printMoveList(legalMoves);

        // prompt user for input
        std::cout << "Enter move (example: " << sample << ") or q to quit: ";
        std::string input;
        std::getline(std::cin, input);

        if (input == "q") {
            exit(0);
        }

        if (!validateCoords(input)) {
            std::cout << "Error: Invalid input" << std::endl;
            continue;
        }

        // check if the move is legal before returning it
        // todo: check for castling
        candidate = Move::fromCoordinateString(input);
        const Square from = candidate.fromSquare(), to = candidate.toSquare();
        const Piece pieceMoved = pos->getBoard().pieceAt(from);

        // check for pawn promotion
        pawnPromoting = (pieceMoved == WP && to <= h8) || (pieceMoved == BP && to >= a1);

        // temporarily set the promotion piece to a queen
        // so that it can match a legal move
        // if (pawnPromoting) {
        //     candidate.setFlag(Move::Type::PROMOTION);
        //     candidate.setPromotedPiece(QUEEN);
        // }

        for (Move move : legalMoves) {
            if (candidate == move) {
                validMove = true;
                candidate = move;
                break;
            }
        }

        if (!validMove) {
            std::cout << "Error: Illegal move. Please try again" << std::endl;
        }
    }

    if (pawnPromoting) {
        while (true) {
            std::cout << "Promotion piece (Q, N, R, B): ";
            std::string promotion;
            std::getline(std::cin, promotion);
            if (promotion == "Q" || promotion == "q") {
                candidate.setPromotedPiece(QUEEN);
                break;
            } else if (promotion == "N" || promotion == "n") {
                candidate.setPromotedPiece(KNIGHT);
                break;
            } else if (promotion == "R" || promotion == "r") {
                candidate.setPromotedPiece(ROOK);
                break;
            } else if (promotion == "B" || promotion == "b") {
                candidate.setPromotedPiece(BISHOP);
                break;
            } else {
                std::cout << "Error: Invalid promotion piece" << std::endl;
            }
        }
    }

    return candidate;
}

void testMakeMove(std::shared_ptr<Position> pos) {
    cout << "Initially:\n";
    prettyPrintPosition(pos);
    printPieceValues(pos);

    // get move
    Move m = getMoveFromStdin(pos);
    cout << "Move: " << m.toString() << "\n";

    // make move
    Position::Metadata md = pos->makeMove(m);
    cout << "After making:\n";
    prettyPrintPosition(pos);
    printPieceValues(pos);

    // unmake move
    pos->unmakeMove(m, md);
    cout << "After unmaking:\n";
    prettyPrintPosition(pos);
    printPieceValues(pos);
}

int main() {
    cout << "Welcome to the testing suite!\n";
    cout << "Enter a FEN or leave blank for starting position: ";
    string fen;
    getline(cin, fen);
    if (fen.empty()) {
        fen = STARTING_POSITION_FEN;
    }

    std::shared_ptr<Position> pos = std::make_shared<Position>(fen);
    std::unique_ptr<Engine> engine = std::make_unique<Engine>(4);
    GameController game(pos, std::move(engine), WHITE);

    legalMoves = game.legalMoves();

    while (1) {
        string choice;
        cout << "===============================\n"
                "Enter an operation:\n"
                "q: Quit\n"
                "1: Make a move\n"
                "2: Show legal moves in this position\n"
                "3: Evaluate this position\n";
        getline(cin, choice);

        switch (choice[0]) {
            case 'q': return 0;
            case '1': testMakeMove(pos); break;
            case '2': pos->printMoveList(legalMoves); break;
            case '3':
                // evaluate this position
                break;
            default: break;
        }
    }
}
